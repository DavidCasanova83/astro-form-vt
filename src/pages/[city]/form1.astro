---
import Header from '../../components/Header.astro';
import "../../styles/global.css";
import cities from '../../data/cities.json';
import departments from '../../data/departments.json';


// Astro doit savoir quelles pages g√©n√©rer avant le build
export async function getStaticPaths() {
  return cities.map(city => ({ params: { city } }));
}
---

<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <title>Formulaire √âtape 1</title> <!-- üî• Valeur par d√©faut -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100 text-gray-800">
    <Header />
    <main class="container mx-auto p-4 max-w-lg"
        x-init="
            city = window.location.pathname.split('/')[1]; 
            document.title = 'Formulaire - ' + city + ' - √âtape 1';
            formAnswers = JSON.parse(localStorage.getItem('formAnswers') || '{}');
            $watch('formAnswers', value => localStorage.setItem('formAnswers', JSON.stringify(value)))
        "
        x-data="{ 
            city: '',  
            country: 'France', 
            department: '', 
            contactMode: 'Accueil physique', 
            formAnswers: {}, 
            departments: [
                '01 - Ain', '02 - Aisne', '03 - Allier', '04 - Alpes-de-Haute-Provence',
                '05 - Hautes-Alpes', '06 - Alpes-Maritimes', '07 - Ard√®che', '08 - Ardennes',
                '09 - Ari√®ge', '10 - Aube', '11 - Aude', '12 - Aveyron', '13 - Bouches-du-Rh√¥ne',
                '14 - Calvados', '15 - Cantal', '16 - Charente', '17 - Charente-Maritime',
                '18 - Cher', '19 - Corr√®ze', '2A - Corse-du-Sud', '2B - Haute-Corse',
                '21 - C√¥te-dOr', '22 - C√¥tes-dArmor', '23 - Creuse', '24 - Dordogne',
                '25 - Doubs', '26 - Dr√¥me', '27 - Eure', '28 - Eure-et-Loir', '29 - Finist√®re',
                '30 - Gard', '31 - Haute-Garonne', '32 - Gers', '33 - Gironde', '34 - H√©rault',
                '35 - Ille-et-Vilaine', '36 - Indre', '37 - Indre-et-Loire', '38 - Is√®re',
                '39 - Jura', '40 - Landes', '41 - Loir-et-Cher', '42 - Loire', '43 - Haute-Loire',
                '44 - Loire-Atlantique', '45 - Loiret', '46 - Lot', '47 - Lot-et-Garonne',
                '48 - Loz√®re', '49 - Maine-et-Loire', '50 - Manche', '51 - Marne',
                '52 - Haute-Marne', '53 - Mayenne', '54 - Meurthe-et-Moselle', '55 - Meuse',
                '56 - Morbihan', '57 - Moselle', '58 - Ni√®vre', '59 - Nord', '60 - Oise',
                '61 - Orne', '62 - Pas-de-Calais', '63 - Puy-de-D√¥me', '64 - Pyr√©n√©es-Atlantiques',
                '65 - Hautes-Pyr√©n√©es', '66 - Pyr√©n√©es-Orientales', '67 - Bas-Rhin',
                '68 - Haut-Rhin', '69 - Rh√¥ne', '70 - Haute-Sa√¥ne', '71 - Sa√¥ne-et-Loire',
                '72 - Sarthe', '73 - Savoie', '74 - Haute-Savoie', '75 - Paris',
                '76 - Seine-Maritime', '77 - Seine-et-Marne', '78 - Yvelines',
                '79 - Deux-S√®vres', '80 - Somme', '81 - Tarn', '82 - Tarn-et-Garonne',
                '83 - Var', '84 - Vaucluse', '85 - Vend√©e', '86 - Vienne', '87 - Haute-Vienne',
                '88 - Vosges', '89 - Yonne', '90 - Territoire de Belfort', '91 - Essonne',
                '92 - Hauts-de-Seine', '93 - Seine-Saint-Denis', '94 - Val-de-Marne',
                '95 - Val-d-Oise', '971 - Guadeloupe', '972 - Martinique', '973 - Guyane',
                '974 - La R√©union', '976 - Mayotte'
            ]
        }">
      
        <h1 class="text-3xl font-bold mb-4">Formulaire - <span x-text="city"></span> - √âtape 1</h1>
      
        <!-- Question 1 : Pays de r√©sidence -->
        <p class="text-xl mb-4">Quel est votre pays de r√©sidence ?</p>
        <div class="flex flex-wrap justify-start gap-2 md:gap-4 mb-4">
            <template x-for="option in ['France', 'Angleterre', 'Allemagne']">
                <button 
                    type="button"
                    x-on:click="country = option"
                    :class="country === option ? 'bg-blue-500 text-white' : 'bg-gray-200 text-black'"
                    class="w-full md:w-auto px-4 py-2 rounded hover:bg-blue-400">
                    <span x-text="option"></span>
                </button>
            </template>
        </div>

        <!-- Question 2 : S√©lection du d√©partement (uniquement si France est s√©lectionn√©) -->
        <template x-if="country === 'France'">
            <div>
                <p class="text-xl mb-2">Dans quel d√©partement r√©sidez-vous ?</p>
                <input 
                    type="text"
                    x-model="department"
                    list="departmentsList"
                    class="border p-2 rounded w-full mb-4"
                    placeholder="Commencez √† taper votre d√©partement...">
                <datalist id="departmentsList">
                    <template x-for="dept in departments" :key="dept">
                        <option x-text="dept"></option>
                    </template>
                </datalist>
            </div>
        </template>

        <!-- Question 3 : Mode de contact -->
        <p class="text-xl mb-4">La prise de contact est par ?</p>
        <div class="flex flex-wrap justify-start gap-2 md:gap-4 mb-4">
            <template x-for="option in ['Accueil physique', 'T√©l√©phone', 'Mail']">
                <button 
                    type="button"
                    x-on:click="contactMode = option"
                    :class="contactMode === option ? 'bg-blue-500 text-white' : 'bg-gray-200 text-black'"
                    class="w-full md:w-auto px-4 py-2 rounded hover:bg-blue-400">
                    <span x-text="option"></span>
                </button>
            </template>
        </div>
      
        <!-- Bouton de validation -->
        <button
            type="button"
            x-on:click="if(country && contactMode && (country !== 'France' || department)){ 
                formAnswers.city = city;
                formAnswers.country = country;
                formAnswers.contactMode = contactMode;
                if (country === 'France') formAnswers.department = department;
                localStorage.setItem('formAnswers', JSON.stringify(formAnswers));
                console.log('Form1 - Donn√©es sauvegard√©es : ', JSON.parse(localStorage.getItem('formAnswers')));

                // Redirige vers l'√©tape 2 en conservant la ville dans l'URL
                window.location.href = '/' + city + '/form2';
            } else { 
                alert('Veuillez s√©lectionner un pays, un mode de contact et un d√©partement si vous √™tes en France.');
            }"
            class="w-full md:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
            Valider
        </button>
    </main>
</body>
</html>
